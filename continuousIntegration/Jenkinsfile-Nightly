#!/usr/bin/env groovy
def functions

pipeline{
	agent none
	triggers{
		cron('H 0 * * 1-5')
	}
	stages{
		stage('Starting Pipeline'){
			options{
				timeout( time : 180, unit: "MINUTES")
			}
			parallel{
				stage('Connecting to Ubuntu agent') {
					agent{
						dockerfile{
							customWorkspace "workspace/${env.JOB_NAME}".replace(' ', '_')
							filename 'continuousIntegration/Dockerfile'
							additionalBuildArgs  '--build-arg BM_SRC_DIR=${WORKSPACE} --build-arg BM_BUILD_DIR=${WORKSPACE}/build'
						}
					}
					stages{
						stage('Preparing Ubuntu workspace'){
							steps{
								deleteDir()
								checkout scm
								script{
									functions = evaluate readTrusted('continuousIntegration/functions.groovy')
									functions.setEnvironment()
								}
							}
						}
						stage('Building on Ubuntu'){
							steps{
								script{
									functions.build("Ubuntu")
								}
							}
						}
						stage('Unit testing on Ubuntu'){
							steps{
								script{
									functions.unitTest("Ubuntu")
								}
							}
						}
						stage('Running executeTests on Ubuntu'){
							steps{
								script{
									functions.executeTests("Ubuntu")
								}
							}
						}
						stage('Deploying on Ubuntu'){
							steps{
								script{
									functions.deploy("Ubuntu")
								}
							}
						}
					}
					post{
						always{
							echo 'Publish unit tests results'
							script{
								functions.publishUnitTestsResultsOnJenkins()
								functions.publishRegressionTestsResultsOnJenkins()
							}
							echo 'Sending email'
							script{
								functions.sendEmail("Ubuntu")
							}
						}
					}
				}
				stage('Connecting to Windows agent'){
					agent{
						node{
							label 'Windows'
							customWorkspace "workspace/" + (env.JOB_NAME.replace(' ', '_')).take(25)
						}
					}
					stages{
						stage( 'Preparing Windows workspace' ){
							steps{
								echo "Preparing windows workspace"
								deleteDir()
								checkout scm
								script{
									functions = evaluate readTrusted('continuousIntegration/functions.groovy')
								}
							}
						}
						stage( 'Building on Windows' ){
							steps{
								script{
									functions.build("Windows")
								}
							}
						}
						stage('Unit testing on Windows'){
							steps{
								script{
									functions.unitTest("Windows")
								}
							}
						}
						stage('Running executeTests on Windows'){
							steps{
								script{
									functions.executeTests("Windows")
								}
							}
						}
						stage('Deploying on Windows'){
							steps{
								script{
									functions.deploy("Windows")
								}
							}
						}
					}
					post{
						always{
							echo 'Publish unit tests results'
							script{
								functions.publishUnitTestsResultsOnJenkins()
								functions.publishRegressionTestsResultsOnJenkins()
							}
							echo 'Sending email'
							script{
								functions.sendEmail("Windows")
							}
						}
					}
				}
			}
		}
	}
}
