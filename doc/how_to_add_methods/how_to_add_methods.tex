\documentclass{article}
\usepackage[utf8]{inputenc}

\title{How to add an new inversion method}
\author{I\~naki Mart\'in Soroa }
\date{22 October 2019}

\begin{document}

\maketitle

\section{Naming conventions and structure}
In order to keep the code well structured, follow the structure used for all the other inversion methods, for this example we consider that we have created the method fooBar:
\begin{itemize}
    \item Your inversion method must implement \textit{inversionInterface}, found in\\ \texttt{libraries/core/inversionInterface.h}.
    \item Use an original name with camelCase ending with ``Inversion''. For example: \textit{fooBarInversion}. Please avoid unoriginal names such as: \textit{fooBarInversion}, \textit{myInversion} or \textit{fasterConjugateGradientInversion}.
    \item Use the same folder structure as other inversion methods. Create a folder in the directory \texttt{libraries/inversion/} with the name of you inversion method, e.g. \textit{fooBarInversion}. That folder must contain a \texttt{CMakeLists.txt} file, a \textit{src} folder with all the \texttt{.cpp} files and a \textit{include} folder with all the \texttt{.h} files.
    \item All the files and classes related to your method should include the inversion method name at the beginning, i.e. an input card reader can be called \textit{fooBarInversionInputCardReader}. The name is long but much more understandable for anyone else using the code later
\end{itemize}

\section{Setting up the Factory}
The \textit{inversionFactory} class takes care of instantiating the desired inversion method. It is the only C++ file that you need to modify outside of your folder. The file is in\\ \texttt{libraries/inversion/inversionFactory/src/inversionFactory.cpp}
\begin{itemize}
    \item Add your method to the includes, i.e. \texttt{\#include "fooBarInversion.h"}.
    \item Add an if condition for your method following the same structure as the other methods, namely:\\\texttt{if (desired\_method == "fooBarInversion")\{}\\\texttt{    inversion = new fooBarInversion(forwardModel, gInput);}\\\texttt{    return inversion;\}}
\end{itemize}

\section{Setting up CMake}
We need to edit 3 different \texttt{CMakeLists.txt} files to ensure that the libraries are properly compiled and linked.
\begin{itemize}
    \item In \texttt{libraries/inversion/CMakeLists.txt}, add a line BEFORE \\\texttt{add\_subdirectory ( inversionFactory ) } with the name of your folder, i.e. \texttt{add\_subdirectory ( fooBarInversion ) }. This adds the folder containing your method to the compilation path.
    \item In your folder, i.e. \texttt{libraries/inversion/fooBarInversion}, the file must compile your method and need to include the libraries that it depends on. The simplest option is to copy the \texttt{CMakeLists.txt} file in another method, i.e. \textit{randomInversion}, and change where it says RANDOM or random for FOO\_BAR or foo\_bar respectively. If you have to add dependencies to some other library, you can add it also in that file.
    \item In \texttt{libraries/inversion/inversionFactory/CMakeLists.txt} we need to make the library with your method available to the \textit{inversionFactory}. In order to do that add your library in the same way that the other inversion methods have been added.
    \begin{itemize}
        \item Add a line adding your directory using \texttt{include\_directories}, i.e.\\\texttt{include\_directories( \$\{LIBRARY\_INCLUDE\_DIRS\_FOO\_BAR\_INVERSION\})}
        \item Add a line linking your library to the \textit{inversionFactory} library. This is added at the end in the command \texttt{target\_link\_libraries(...)}. Add your library in the same way that the other inversion methods are added, i.e. \texttt{foo\_bar\_inversion\_library} separated by a space from the other linked libraries.  
    \end{itemize}
\end{itemize}
\end{document}
