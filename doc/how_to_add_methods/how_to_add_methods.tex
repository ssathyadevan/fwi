\documentclass{article}
\usepackage[utf8]{inputenc}

\title{How to add an new inversion method or forward model}
\author{I\~naki Mart\'in Soroa }
\date{4 November 2019}

\begin{document}

\maketitle

\section{Naming conventions and structure}
In order to keep the code well structured, follow the structure used for all the other inversion methods or forward models, for this example we consider that we have created the method FooBar:
\begin{itemize}
    \item Your inversion method must implement \textit{inversionInterface}, found in\\ \texttt{libraries/core/inversionInterface.h}. (Or the ForwardModelInterface if you add a forward model).
    \item Use an original name with camelCase ending with ``Inversion'' (or ``ForwardModel''). For example: \textit{fooBarInversion}. Please avoid unoriginal names such as: \textit{fooBarInversion}, \textit{myInversion} or \textit{fasterConjugateGradientInversion}.
    \item Use the same folder structure as other methods. Create a folder in the directory \texttt{libraries/inversion/} (or \texttt{/forwardModel} with the name of your method, e.g. \textit{fooBarInversion}. That folder must contain a \texttt{CMakeLists.txt} file, a \textit{src} folder with all the \texttt{.cpp} files and a \textit{include} folder with all the \texttt{.h} files.
    \item All the files and classes related to your method should include the method name at the beginning, i.e. an input card reader can be called \textit{fooBarInversionInputCardReader}. The name is long but much more understandable for anyone else using the code later
\end{itemize}

\section{Setting up the Factory}
The \textit{Factory} class takes care of instantiating the desired method and model. It is the only C++ file that you need to modify outside of your folder. The file is in\\ \texttt{libraries/factory/src/factory.cpp}
\begin{itemize}
    \item Add your method to the includes, i.e. \texttt{\#include "fooBarInversion.h"}.
    \item Add an if condition for your method following the same structure as the other methods, namely:\\\texttt{if (desired\_method == "fooBarInversion")\{}\\\texttt{    inversion = new fooBarInversion(forwardModel, gInput);}\\\texttt{    return inversion;\}}\\ The same applies to forward models.
\end{itemize}

\section{Setting up CMake for Inversion methods}
We need to edit 3 different \texttt{CMakeLists.txt} files to ensure that the libraries are properly compiled and linked.
\begin{itemize}
    \item In \texttt{libraries/inversion/CMakeLists.txt}, add a line with the name of your folder, i.e. \texttt{add\_subdirectory ( fooBarInversion ) }. This adds the folder containing your method to the compilation path.
    \item In your folder, i.e. \texttt{libraries/inversion/fooBarInversion}, a \texttt{CMakeLists.txt} file must compile your method and needs to include the libraries that it depends on. The simplest option is to copy the \texttt{CMakeLists.txt} file in another method, i.e. \textit{randomInversion}, and change where it says RANDOM or random for FOO\_BAR or foo\_bar respectively. If you have to add dependencies to some other library, you can add it also in that file.
    \item In \texttt{libraries/factory/CMakeLists.txt} we need to make the library with your method available to \textit{Factory}. In order to do that add your library in the same way that the other methods have been added. Add a line adding your directory using \texttt{include\_directories}, i.e.\\\texttt{include\_directories( \$\{LIBRARY\_INCLUDE\_DIRS\_FOO\_BAR\_INVERSION\})}
    \item In the same file, link your library to the \texttt{target\_link\_libraries} command, i.e. add \texttt{foo\_bar\_inversion\_library} to the list of libraries.
\end{itemize}


\section{Setting up CMake for Forward Models}
We need to edit 4 different \texttt{CMakeLists.txt} files to ensure that the libraries are properly compiled and linked.
\begin{itemize}
    \item In \texttt{libraries/forwarModel/CMakeLists.txt}, add a line with the name of your folder, i.e. \texttt{add\_subdirectory ( fooBarForwardModel ) }. This adds the folder containing your method to the compilation path.
    \item In your folder, i.e. \texttt{libraries/forwardModel/fooBarForwardModel}, a \texttt{CMakeLists.txt} file must compile your method and needs to include the libraries that it depends on. The simplest option is to copy the \texttt{CMakeLists.txt} file in another forward model, i.e. \textit{integralForwardModel}, and change where it says INTEGRAL or integral for FOO\_BAR or foo\_bar respectively. If you have to add dependencies to some other library, you can add it also in that file.
    \item In \texttt{libraries/factory/CMakeLists.txt} we need to make the library with your method available to \textit{Factory}. In order to do that add your library in the same way that the other methods have been added. Add a line adding your directory using \texttt{include\_directories}, i.e.\\\texttt{include\_directories( \$\{LIBRARY\_INCLUDE\_DIRS\_FOO\_BAR\_FORWARDMODEL\})}
    \item In \texttt{application/unifiedProcessing/CMakeLists.txt}, add a line including your directory using \texttt{include\_directories}, i.e. \\\texttt{include\_directories( \$\{LIBRARY\_INCLUDE\_DIRS\_FOO\_BAR\_FORWARDMODEL\})}.
    \item In the same file, add you library to the \texttt{target\_link\_libraries}, i.e. add \texttt{foo\_bar\_forwardModel\_library}.
\end{itemize}
\end{document}
